# 藍線路徑圖規則（inauspicious2）

本說明文件記錄目前 ReactFlow 圖的資料來源、節點類型、線段間距、合併策略與次行（子路徑）裁切連線等規則，供維護與調整。

## 資料來源與簡化序列 simpleRoutes

-   來源為 `routes` 物件序列，轉換為字串序列 `simpleRoutes`：僅保留宮位/星體/特殊字串。
-   移除重複：遇到相同字串只保留首次出現。
-   若首個項為「生年忌」，序列中會依序加入「生年忌 → 該星 → 目的宮」。

## 節點型別判斷

-   宮位：字串以「宮」結尾 → 橢圓 `eclipse` 節點。
-   星體：兩個字且不以「宮」結尾 → 矩形 `star` 節點。
-   生年忌：`"生年忌"` → 藍色橢圓節點（視作宮位）。
-   自化忌：`"自化忌"` → 藍色虛線節點（`blue`）。

## 間距與箭頭

-   `gapA = 40px`：宮位 → 星體 的水平距離（主間距）。
-   `gapB = 4px`：星體 → 宮位 的水平距離（短間距）。
-   任意節點 → 「自化忌」一律使用 `gapA`；若「自化忌」緊跟在星體之後，星體節點會開啟右側連接點，藍箭頭由星體指向「自化忌」。
-   針對次行接到主行的連線，使用自訂 `rightangle` 邊 two-segment HV（水平 → 垂直），水平折點 `bx` 精準對準目標節點底部接點（BT）的 `targetX`，確保「正下方落點」。

## 頭部宮位與底部面板

-   路徑頭部名稱：取序列中第一個以「宮」結尾的字串。
-   底部面板按鈕：無論是否選取路徑皆顯示；依 `simpleRoutes` 推導標籤並可切換顯示。

## 合併策略（多路徑選取）

-   合併條件一：兩序列需有至少一個共同字串，且在第一條序列中的共同項索引需嚴格遞增（保持相對順序）→ 視為「無衝突」。
-   合併條件二（補強）：若其中一條的「尾宮」等於另一條的「頭宮」→ 亦可直接串接合併。
-   合併流程：
    -   針對所有「已選路徑」嘗試兩兩合併，直到無法再合併。
    -   每個合併群組使用「同一張 ReactFlow 畫布」呈現。
    -   群組內「最長」序列作為主行（第一行）。
    -   其餘序列作為次行（子路徑）依序疊在主行之下，行距 `branchGapY = 80px`。

## 次行裁切與連線（避免重複）

-   找到次行與主行「最後一個共同的星體」（優先星體，例如「文曲」），以該星體作為裁切點：
    -   移除該星體及其之後的節點，使次行不重複顯示「文曲、財帛宮」等。
    -   從次行「最後保留節點」畫一條 two-segment HV 藍箭頭連到主行該星體的「底部接點 BT」。
-   為了接收該箭頭，目標節點（星體或宮位）會啟用 `BT` 接點（底部 target）。

## 其他顯示規則

-   不渲染空圖：若 `flow.nodes` 與 `flow.edges` 皆為空，該卡片不顯示。
-   排序：同時顯示多張卡片時，依節點數量由多到少排列（較長在上、較短在下）。

## 目前可調參數（若需調整請修改程式常數）

-   `gapA = 40`、`gapB = 4`、`branchGapY = 80`。
-   two-segment HV 箭頭使用 `bx = targetX` 以「精準對準」目標 BT。

## 備註

-   `star` 節點在需接收自下而上的連線時也會打開 `BT` 接點。
-   任何變更請同步更新本檔與 `index.js` 中相對應的常數與判斷，確保行為一致。

---

## 近期更新（合併與裁切邏輯強化）

-   **情境鍵（Context Key）比對**：

    -   對宮位使用「`前置星 -> 宮`」作為比對鍵。例如「巨門 → 交友宮」與「天同 → 交友宮」會視為不同節點，避免誤合併。
    -   分群、重疊偵測、主線吸收尾段、次行裁切與排序均改用情境鍵。

-   **多群組合併與單畫布多車道**：

    -   以「任一方向有重疊」或「存在任一共同情境鍵」建立重疊圖，找出連通元件（群組）。
    -   群組內以最長序列為主線，其他序列成為次行（子路徑）並與主線裁切連線；不同群組分別渲染為多張 ReactFlow。

-   **主線吸收（完整/部分）**：

    -   前綴/後綴重疊：直接將尾段 append 或頭段 prepend 至主線。
    -   內部重疊：
        -   主線尾段出現在次線中段 → 吸收其後尾巴（確保「…文曲 → 財帛宮」後仍能接上「天同 → 交友宮」）。
        -   主線前段出現在次線中段 → 吸收其前頭部，重建主線。

-   **次行裁切與連線**：

    -   以「最早的共享星體」為優先裁切點，若無星體則最早的共享節點。
    -   裁切後的最後節點以 two-segment HV 指向主線共享節點的 BT。
    -   次行建立順序改為依「裁切前可保留長度」由大到小（其次以原始長度），較長者先加入，較短者更容易被判定為重複而略過。
    -   裁切後僅剩 1 節點時：只有在「該節點已出現在已渲染內容（主線或較早的次行）」才略過；否則保留並連線到主線。

-   **自化忌間距與箭頭**：

    -   星體後接「自化忌」時固定使用 `gapA=40px`，星體會開啟右側連接點，由星體右側連至「自化忌」。
    -   仍保留無星體時的宮位 → 自化忌 `gapA` 間距退場機制。

-   **HV 邊精準落點**：

    -   two-segment HV 的水平折點對齊目標 BT 的 `targetX`，確保箭頭垂直落點精準。

-   **單節點重複濾除**：
    -   單節點次行（如只剩「疾厄宮」）若該節點已於主線或已加入的次行出現，將略過；否則保留。

---

## 近期更新（Loopback 與佈局）

-   **重複「星 → 宮」配對的 Loopback（HVHV 回折）**：

    -   當主線延伸時遇到與主線中「既有」的相同情境鍵「`星->宮`」配對，將不再重複建立「星、宮」節點。
    -   以一條藍色 HVHV 回折邊表示「循環」：
        -   從當前最後的宮位向右（水平）→ 向上（垂直）→ 向左（水平）→ 向下（垂直）落於目標星節點的頂部接點 `T`。
        -   目標星節點會自動開啟 `T` 接點以接收回折連線。
        -   「是否重複」以情境鍵判定：必須是同一顆星接到同一宮，例：「文曲 → 財帛宮」；僅宮相同但星不同（如「天同 → 交友宮」與「巨門 → 交友宮」）不視為重複。
    -   邊型支援：
        -   新增 `HVHV` 模式（四段：水平 → 垂直 → 水平 → 垂直）。
        -   既有兩段 `HV` 邊仍用於次行接主線（水平 → 垂直，對準目標 `BT`）。
    -   回折目標固定為「主線上最早出現」的該星節點（`y=0` 且 `x` 最小者），避免對較晚出現的相同節點重複回折。
    -   若次行在回折點之前仍有內容（例如「天同 → 交友宮」），會先完整繪製該前綴，再從當前宮回折到主線最早的「文曲」。
    -   若整條次行序列已是主線的「連續子序列」，將完全略過，不繪製額外節點、邊與回折。

---

## 近期更新（高度與佈局調整）

-   上方可捲動容器高度為 `85vh`，底部固定面板不再壓縮單圖高度計算。
-   同時顯示多張圖卡時，卡片整體高度依視窗高度按比例分配：
    -   以 `containerRatio = 0.9 / N`（`N` 為可見圖卡數）計算卡片高度，約為：1 張 90%、2 張 45%、3 張 30%、4 張 22.5%（皆以視窗高度為基準）。
    -   ReactFlow 實際渲染區高度為卡片高度的約 90%，`fitView` padding 採 `0.05`，盡量放大內容而不裁切。
-   寬度：以 `max(90% viewport, 內容需求寬度)` 呈現。

---

## 近期更新（車道吸收與緊縮）

-   對同一目標共享節點（星/宮），若新加入的次行保留段「尾段」包含已存在的較短次行，將吸收並刪除較短次行（包含其節點與邊）。
-   吸收後，新次行會沿用被刪除次行的 `y` 列位置，避免留下空行。
-   在所有次行處理完後，會掃描次行的列並「緊縮列索引」，填補中間空列，確保第 2、3、4 列連續緊湊。
-   次行建立時，會將整段「向右對齊到目標左側」以縮短 HV 水平段（預設 `desiredRightGap = 40px`）。
