# 流程圖繪製邏輯總結

## 概述

這個流程圖系統用於繪製紫微斗數的星曜關係圖，支援多層級節點佈局和複雜的箭頭連接。

## 核心組件

### 節點類型

1. **主宮位節點 (PalaceNode)**

    - 尺寸：140x60px
    - 顯示兩行文字：星曜名稱（上）+ 宮位名稱（下）
    - 條件性連接點：只顯示實際使用的連接點
    - 四個可能的連接點：T(上)、B(下)、L(左)、R(右)

2. **紅色節點 (RedNode)**

    - 尺寸：100x32px
    - 用於顯示「權」相關的星曜
    - 固定右側連接點，連接到主節點左側

3. **綠色節點 (GreenNode)**

    - 尺寸：100x32px
    - 用於顯示「祿」相關的星曜
    - 固定左側連接點，連接到主節點右側

4. **最終節點 (LastNode)**
    - 尺寸：140x60px（與主節點相同）
    - 用於外部連接的終端節點
    - 條件性連接點：通常只顯示頂部連接點
    - 外觀：白色背景，灰色邊框（與主節點統一）

### 佈局算法

#### 1. 層級分配 (Kahn 算法)

-   使用拓撲排序將節點分配到不同層級
-   頭節點（入度為 0）在頂層
-   根據依賴關係向下分層
-   層間距：280px

#### 2. 水平位置計算

-   每層內按節點索引排序
-   考慮紅綠節點的空間需求計算間距
-   最小間距：40px
-   自動居中對齊

#### 3. 紅綠節點位置

-   紅色節點：主節點左側，向上偏移 32px
-   綠色節點：主節點右側，向上偏移 32px
-   垂直間距：32px（多個節點時）

### 箭頭連接邏輯

#### 1. 藍色箭頭（主要流向）

-   **流向限制**：只顯示向下流動的箭頭（sourceLayer < targetLayer）
-   **連接點**：從源節點底部(B) → 目標節點頂部(T)
-   **路徑類型**：直角轉折（RightAngleEdge）
-   **重疊避免**：
    -   基本偏移：每條線 18px 錯開
    -   轉折點偏移：同層箭頭間隔 15px
    -   避讓間隙：80px 基礎間隙 + 個別偏移

#### 2. 紅色箭頭（權關係）

-   連接：紅色節點右側(R) → 主節點左側(L)
-   路徑：直線
-   箭頭方向：
    -   「自化權」：反向箭頭（markerStart）
    -   其他：正向箭頭（markerEnd）

#### 3. 綠色箭頭（祿關係）

-   連接：主節點右側(R) → 綠色節點左側(L)
-   路徑：直線
-   箭頭方向：
    -   「自化祿」：正向箭頭（markerEnd）
    -   其他：反向箭頭（markerStart）

#### 4. 外部最終箭頭

-   連接：主節點底部(B) → 最終節點頂部(T)
-   路徑：直線（垂直連接）
-   間距：120px 垂直間隔
-   觸發條件：節點為終端節點且有外部最終節點數據

### 連接點顯示邏輯

節點只顯示實際使用的連接點：

**主宮位節點 (PalaceNode):**

-   **T（頂部）**：有藍色箭頭指向此節點
-   **B（底部）**：此節點有藍色箭頭指向其他節點，或有外部最終節點連接
-   **L（左側）**：有紅色節點連接
-   **R（右側）**：有綠色節點連接

**最終節點 (LastNode):**

-   **T（頂部）**：接收來自主節點的連接（預設顯示）
-   **B（底部）**：通常隱藏，除非有進一步連接需求

### 重疊避免策略

#### 1. 藍色箭頭分層

-   按源層級分組箭頭
-   同層內按源節點索引排序
-   每條線分配唯一的轉折點高度（15px 間隔）

#### 2. 空間配置

-   層間距：280px（容納 60px 高節點 + 紅綠節點偏移 + 藍色箭頭空間）
-   轉折間隙：80px 基礎 + 動態偏移
-   容器高度：440px 基礎 + 420px × 層數

#### 3. 循環處理

-   檢測並消除向上指向的箭頭
-   只保留向下流動的連接（sourceLayer < targetLayer）

## 自定義邊類型

### RightAngleEdge

-   實現 90 度直角轉折
-   支援動態偏移避免重疊
-   路徑：垂直 → 水平 → 垂直
-   參數：
    -   `offsetY`：基本垂直偏移
    -   `avoidNodes`：是否避開紅綠節點
    -   `turnPointOffset`：轉折點個別偏移

## 數據結構

每個節點包含：

```javascript
{
  name: "宮位名稱",
  star: "星曜名稱",
  innerGreen: ["祿相關宮位"],
  innerRed: ["權相關宮位"],
  outerBlue: { star: "星曜", name: "宮位" }, // 用於最終節點的數據
  tail: 目標節點索引,
  heads: [源節點索引陣列]
}
```

### 節點類型映射

在 ReactFlow 中的節點類型：

-   `palace`: 主宮位節點 (PalaceNode)
-   `red`: 紅色節點 (RedNode)
-   `green`: 綠色節點 (GreenNode)
-   `last`: 最終節點 (LastNode)

## 樣式配置

-   主節點：白色背景，灰色邊框，陰影效果
-   紅色節點：淺紅背景，紅色邊框
-   綠色節點：淺綠背景，綠色邊框
-   最終節點：白色背景，灰色邊框（與主節點統一）
-   箭頭大小：藍色 20x20px，紅綠 20x20px

## 性能優化

-   使用 useMemo 快取節點類型和邊類型
-   組件分離避免重複渲染
-   條件性連接點減少 DOM 元素
