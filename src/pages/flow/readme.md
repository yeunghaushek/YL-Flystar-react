# 流程圖繪製邏輯總結

## 概述

這個流程圖系統用於繪製紫微斗數的星曜關係圖，支援多層級節點佈局和複雜的箭頭連接。

## 核心組件

### 節點類型

1. **星體節點 (StarNode)**

    - 尺寸：140x60px
    - 顯示：僅星曜名稱
    - 條件性連接點：T(上)、L(左)、R(右)

2. **宮位節點 (PalaceEllipse)**

    - 尺寸：120x32px（橢圓）
    - 顯示：僅宮位名稱
    - 條件性連接點：B(下)

3. **紅色節點 (RedNode)**

    - 尺寸：100x32px
    - 用於顯示「權」相關的星曜
    - 固定右側連接點，連接到星體節點左側

4. **綠色節點 (GreenNode)**

    - 尺寸：100x32px
    - 用於顯示「祿」相關的星曜
    - 固定左側連接點，連接到星體節點右側

5. **藍色節點 (BlueNode)**

    - 尺寸：100x32px（與紅/綠節點一致）
    - 用於顯示「自化忌」
    - 連接：從宮位節點底部(B) 以直線連到藍色節點頂部(T)
    - 外觀：淺藍背景、藍色邊框、黑色文字（與紅/綠一致字重與尺寸）

### 佈局算法

#### 1. 層級分配（以 head 鏈順序垂直排列）

-   先以「沒有 heads（或為空陣列）」的節點作為 head，針對每個 head 依 `tail` 串出鏈（去除回圈造成的重複）
-   同一鏈的第 i 個節點固定放在第 i 層，達成純直向排列
-   預設層間距：200px（直向流程已足夠，無需大型緩衝）

#### 2. 水平位置計算

-   每層內按節點索引排序
-   考慮紅綠節點的空間需求計算間距
-   自動居中對齊

#### 3. 紅綠節點位置

-   紅色節點：星體節點左側，向上偏移 32px
-   綠色節點：星體節點右側，向上偏移 32px
-   垂直間距：32px（多個節點時）

### 箭頭連接邏輯

#### 1. 藍色箭頭（主要流向）

-   **連接點**：從宮位節點底部(B) → 星體節點頂部(T)
-   **路徑類型**：直角轉折（RightAngleEdge）
-   **轉折高度（midY）規劃（一般層）**：
    -   為每來源層建立可用帶 [bandBottom, bandTop]
        -   `bandBottom = layer*layerHeight + MAIN_NODE_HEIGHT + baseBelow`（頂層 baseBelow=20，其餘層 60）
        -   `bandTop = (layer+0.5)*layerHeight - 4`
    -   目標中心：層中線 `layer*layerHeight + layerHeight/2`
    -   同層以 `spacing = 4px` 置中分槽分離
    -   全域唯一配置：以 4px 步長為所有藍線指派唯一 `fixedMidY`，避免跨層/同層重疊
    -   `avoidNodes=true`：轉折高度會夾在允許帶內，避免壓到星體節點與紅/綠側節點

#### 2. 紅色箭頭（權關係）

-   連接：紅色節點右側(R) → 星體節點左側(L)
-   路徑：直線
-   箭頭方向：
    -   「自化權」：反向箭頭（markerStart）
    -   其他：正向箭頭（markerEnd）

#### 3. 綠色箭頭（祿關係）

-   連接：星體節點右側(R) → 綠色節點左側(L)
-   路徑：直線
-   箭頭方向：
    -   「自化祿」：正向箭頭（markerEnd）
    -   其他：反向箭頭（markerStart）

#### 4. 外部最終箭頭（拆成星體節點 + 宮位節點）

-   連接：來源宮位節點底部(B) → 目的地星體節點頂部(T)
-   路徑：直線（確保箭頭由上而下）
-   目的地節點：在星體節點下方新增對應的宮位橢圓節點（不開把手）
-   觸發條件：`outerBlue` 存在且非「自化忌」

#### 5. 自化忌外部藍點

-   連接：宮位節點底部(B) → 藍色節點頂部(T)
-   路徑：直線（確保箭頭由上而下）
-   文字：僅顯示「自化忌」

### 連接點顯示邏輯

節點只顯示實際使用的連接點：

**星體節點 (StarNode):**

-   **T（頂部）**：有藍色箭頭指向此節點
-   **L（左側）**：有紅色節點連接
-   **R（右側）**：有綠色節點連接

**宮位節點 (PalaceEllipse):**

-   **B（底部）**：此節點有藍色箭頭指向其他節點（或自化忌藍點）

**藍色節點 (BlueNode):**

-   **T（頂部）**：接收來自主節點的連接
-   **B（底部）**：通常隱藏

### 重疊避免策略

#### 1. 轉折高度規劃（一般層）

-   層帶控制可用區；無需大型動態偏移
-   同層以 `spacing = 4px` 置中分槽分離
-   以 4px 網格的全域配置為所有藍線指派唯一 midY，避免跨層重疊

#### 2. 空間配置

-   層間距：200px
-   轉折帶邊界：`baseBelow` 20/60px、層中線保護 4px
-   容器高度：由內容與視窗高度共同決定（見下段「自動貼齊與縮放」）

#### 3. 循環處理（直向視覺，不做階梯）

-   仍偵測回圈，但以 4 轉折的回返藍線表示：`bendY1`（至下方）、`bendX`（側向迴轉）、`bendY2`（回到 head 上方）
-   不建立重複節點；回返線直接由最後節點 B 連回首節點 T

## 自定義邊類型

### RightAngleEdge

-   實現 90 度直角轉折（垂直 → 水平 → 垂直）
-   參數：
    -   `offsetY`：基本垂直偏移
    -   `avoidNodes`：避開節點/側節點
    -   `bendY1/bendY2/bendX`：回圈回返線的四轉折參數
    -   `fixedMidY`：強制轉折高度
    -   `minMidY`/`maxMidY`：允許高度帶
    -   `centered`：上下段等長（示意用）

## 數據結構

每個節點包含：

```javascript
{
  name: "宮位名稱",
  star: "星曜名稱",
  innerGreen: ["祿相關宮位"],
  innerRed: ["權相關宮位"],
  outerBlue: { star: "星曜", name: "宮位" }, // 用於最終節點的數據
  tail: 目標節點索引,
  heads: [源節點索引陣列]
}
```

### 節點類型映射

在 ReactFlow 中的節點類型：

-   `star`: 星體節點 (StarNode)
-   `eclipse`: 宮位節點 (PalaceEllipse)
-   `red`: 紅色節點 (RedNode)
-   `green`: 綠色節點 (GreenNode)
-   `blue`: 藍色節點 (BlueNode)
-   `last`: 最終節點 (LastNode, 目前僅保留為相容用途，不再用於外部終點)

## 破壞性變更（Breaking Changes）

-   原「主宮位節點」現拆為「星體節點」與「宮位節點」兩個獨立節點：
    -   星體節點（矩形）顯示星曜名稱，承接紅/綠側節點，頂部接收藍線
    -   宮位節點（橢圓）顯示宮位名稱，底部送出藍線
-   外部最終節點（LastNode）不再作為外部藍線的終點：
    -   以「目的地星體節點 + 目的地宮位節點」取代，藍線自來源宮位(B) 直線連到目的地星體(T)
    -   「自化忌」改以藍色小節點呈現，仍由來源宮位(B) 直線連入
-   若既有程式或文件假設主節點同時含星曜與宮位，請更新為：
    -   使用 `m-<idx>`／`p-<idx>` 對應星體/宮位節點
    -   藍線：`p-<idx>` (B) → `m-<idx或外部>` (T)

## 樣式配置

-   星體節點：白色背景，灰色邊框，陰影效果
-   宮位節點：白色背景，灰色邊框，橢圓外觀
-   紅色節點：淺紅背景，紅色邊框
-   綠色節點：淺綠背景，綠色邊框
-   藍色節點：淺藍背景，藍色邊框
-   箭頭大小：藍色 20x20px，紅綠 20x20px

## 版面配置（ReactFlow 容器）

-   水平排列：外層以 `display:flex` 水平排版，支援水平捲動
-   單圖寬度：至少為視窗寬度減去外邊距（約 `window.innerWidth - 48`），或內容所需寬度（含回返 `bendX`）
-   多圖寬度：每張至少約 `36vw`，或內容寬度擇大值

### 自動貼齊與縮放

-   依內容計算 `boundsWidth/boundsHeight`，動態設定每張圖的寬高
-   高度：`computedHeight = clamp(boundsHeight + 80, viewportH - 96, viewportH - 32)`，同時預留回折緩衝
-   啟用 `fitView`，`fitViewOptions: { padding: 0.5, includeHiddenNodes: true }`，初始略縮小以完整呈現
-   `minZoom = 0.2`、`maxZoom = 1.5`，方便手動微調
